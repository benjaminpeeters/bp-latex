%% bp-common.sty
%% Common packages for papers, books, and notes (NOT beamer)
%% Contains: math, theorems, tables, figures, hyperref/cleveref, natbib
%%
%% Copyright (C) 2025 Benjamin Peeters
%% Licensed under AGPL-3.0

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bp-common}[2025/01/01 Benjamin Peeters common LaTeX packages]

\RequirePackage{bp-core}

%=====================================================================
% MATH PACKAGES AND COMMANDS
%=====================================================================

\RequirePackage{amsmath,amssymb,amsfonts}
\RequirePackage{amsthm}
\RequirePackage{mathrsfs}
\RequirePackage{bbold}
\RequirePackage{cancel}
\RequirePackage{nicefrac}

% Math commands
\newcommand{\bs}[1]{\boldsymbol{#1}}
\newcommand{\argmin}{\arg\!\min}
\newcommand{\argmax}{\arg\!\max}
\newcommand{\R}{\mathbb{R}}

% Independence symbol
\newcommand\independent{\protect\mathpalette{\protect\independenT}{\perp}}
\def\independenT#1#2{\mathrel{\rlap{$#1#2$}\mkern2mu{#1#2}}}

%=====================================================================
% THEOREM ENVIRONMENTS
%=====================================================================

\newtheorem{theorem}{Theorem}[section]
\newtheorem{assumption}{Assumption}
\newtheorem{hypothesis}{Hypothesis}
\newtheorem{proposition}{Proposition}
\newtheorem{conjecture}{Conjecture}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{observation}{Observation}

\theoremstyle{definition}
\newtheorem{definition}{Definition}

%=====================================================================
% FIGURE AND TABLE PACKAGES
%=====================================================================

\RequirePackage{float}
\RequirePackage{array}
\RequirePackage{caption}
\RequirePackage{subfigure}
\RequirePackage{multicol,multirow}
\RequirePackage{threeparttable}
\RequirePackage{supertabular}
\RequirePackage{longtable}
\RequirePackage{diagbox}
\RequirePackage{rotating}
\RequirePackage{booktabs}
\RequirePackage{epstopdf}
\RequirePackage{lscape}
\RequirePackage{pdflscape}

% Table helper command
\newcommand{\STAB}[1]{\begin{tabular}{@{}c@{}}#1\end{tabular}}

%=====================================================================
% TIKZ
%=====================================================================

\RequirePackage{tikz}
\usetikzlibrary{positioning}
\usetikzlibrary{math}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{arrows,shapes,backgrounds,fit}

%=====================================================================
% BIBLIOGRAPHY (NATBIB)
%=====================================================================

\RequirePackage{natbib}
\setcitestyle{authoryear,round}
\renewcommand{\bibsection}{}
\RequirePackage{url}
\urlstyle{tt}

%=====================================================================
% HYPERREF AND CROSS-REFERENCES
%=====================================================================

\RequirePackage{hyperref}
\hypersetup{final}  % Override global 'draft' option that disables colored links

% Apply color settings based on bp-core flags
% Note: colorlinks and bw/nocolorlinks are mutually exclusive
% - colorlinks: colored links (red/blue/teal)
% - nocolorlinks or bw: black links
\ifbp@colorlinks
    \ifbp@colorsimple
        % Default hyperlink setup (let hyperref choose)
    \else
        \hypersetup{
            colorlinks=true,
            linkcolor={myred},
            citecolor={myblue},
            urlcolor={url_blue}
        }
    \fi
\else
    % Both bw and nocolorlinks result in black links
    \hypersetup{
        colorlinks=true,
        linkcolor={black},
        citecolor={black},
        urlcolor={black}
    }
\fi

\RequirePackage{xr-hyper}
\RequirePackage{varioref}
\RequirePackage[capitalise,noabbrev]{cleveref}

% Cleveref format customizations
\crefformat{footnote}{#2\footnotemark[#1]#3}
\creflabelformat{equation}{#2#1#3}
\crefrangelabelformat{equation}{#3#1#4 to~#5#2#6}

% Cleveref theorem integration
\Crefname{theorem}{Theorem}{Theorems}
\Crefname{assumption}{Assumption}{Assumptions}
\Crefname{hypothesis}{Hypothesis}{Hypotheses}
\Crefname{proposition}{Proposition}{Propositions}
\Crefname{conjecture}{Conjecture}{Conjectures}
\Crefname{lemma}{Lemma}{Lemmas}
\Crefname{corollary}{Corollary}{Corollaries}
\Crefname{observation}{Observation}{Observations}

%=====================================================================
% TODO NOTES
%=====================================================================

\RequirePackage{xargs}
\setlength{\marginparwidth}{2cm}
\RequirePackage[colorinlistoftodos,prependcaption,textsize=small]{todonotes}

\ifbp@todo
    \newcommandx{\unsure}[2][1=]{\todo[linecolor=orange,backgroundcolor=orange!15,bordercolor=orange,#1]{#2}}
    \newcommandx{\change}[2][1=]{\todo[linecolor=red,backgroundcolor=red!15,bordercolor=red,#1]{#2}}
    \newcommand{\comment}[1]{\todo[inline]{#1}}
\else
    \newcommand{\unsure}[1]{\ignorespaces}
    \newcommand{\change}[1]{\ignorespaces}
    \newcommand{\comment}[1]{\ignorespaces}
\fi

%=====================================================================
% DRAFT WATERMARK
%=====================================================================

\ifbp@draft
    \RequirePackage{draftwatermark}
    \SetWatermarkText{DRAFT}
    \SetWatermarkScale{0.5}
    \SetWatermarkColor[gray]{0.9}
\fi

%=====================================================================
% MISCELLANEOUS
%=====================================================================

\RequirePackage{lipsum}
\RequirePackage{datetime}
\RequirePackage[useregional=numeric]{datetime2}
\RequirePackage{textcomp}
\RequirePackage{manyfoot}
\RequirePackage{algorithm}
\RequirePackage{algorithmicx}
\RequirePackage{algpseudocode}
\RequirePackage[title]{appendix}

\endinput
